
####################################
# ARRAKIS STRUGGLE EVENTS
####################################

####################################
# UTILITY EVENTS (0001-0009)
####################################

namespace = arrakis_struggle
arrakis_struggle.0001 = {
    type = character_event
    title = arrakis_struggle.0001.t
    desc = arrakis_struggle.0001.desc
    theme = war
    hidden = yes

    trigger = {
        exists = global_var:arrakis_struggle_active
    }

    immediate = {
        # Set up recurring catalyst check
        trigger_event = {
            id = arrakis_struggle.0005
            days = 365
        }
    }

    option = {
        name = arrakis_struggle.0001.a
    }
}

# Player Joins Struggle Notification
arrakis_struggle.0002 = {
    type = character_event
    title = arrakis_struggle.0002.t
    desc = arrakis_struggle.0002.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    trigger = {
        is_ai = no
    }

    option = {
        name = arrakis_struggle.0002.a
        custom_tooltip = struggle_begins_tt
    }
}

# Yearly Catalyst Pulse
arrakis_struggle.0005 = {
    type = character_event
    hidden = yes

    trigger = {
        exists = global_var:arrakis_struggle_active
        NOT = { exists = global_var:arrakis_struggle_ended }
    }

    immediate = {
        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_arrakis_yearly_drift
                character = root
            }
        }

        # Reschedule
        trigger_event = {
            id = arrakis_struggle.0005
            days = 365
        }
    }

    option = {
        name = OK
    }
}

####################################
# PHASE 1: OPPRESSION EVENTS (010-019)
####################################

# The Jamis Duel - Paul's first kill
arrakis_struggle.010 = {
    type = character_event
    title = arrakis_struggle.010.t
    desc = arrakis_struggle.010.desc
    theme = duel

    left_portrait = {
        character = root
        animation = personality_bold
    }

    right_portrait = {
        character = scope:jamis
        animation = rage
    }

    trigger = {
        has_character_flag = paul_atreides
        NOT = { has_character_flag = defeated_jamis }
        is_alive = yes
    }

    immediate = {
        # Find or create Jamis
        if = {
            limit = {
                any_living_character = {
                    has_character_flag = jamis_fremen
                }
            }
            random_living_character = {
                limit = { has_character_flag = jamis_fremen }
                save_scope_as = jamis
            }
        }
        else = {
            create_character = {
                template = fremen_warrior_template
                save_scope_as = jamis
            }
            scope:jamis = {
                add_character_flag = jamis_fremen
            }
        }
    }

    # Fight honorably
    option = {
        name = arrakis_struggle.010.a

        duel = {
            skill = prowess
            target = scope:jamis
            50 = {
                compare_modifier = {
                    value = scope:duel_value
                    multiplier = 3.5
                }
                desc = arrakis_struggle.010.a.success
                send_interface_toast = {
                    title = arrakis_struggle.010.a.success
                    left_icon = root
                    right_icon = scope:jamis
                }

                scope:jamis = {
                    death = {
                        death_reason = death_duel
                        killer = root
                    }
                }

                add_character_flag = defeated_jamis
                add_prestige = 200

                # Fremen respect
                every_living_character = {
                    limit = { has_culture = culture:fremen }
                    add_opinion = {
                        target = root
                        modifier = respect_opinion
                        opinion = 15
                    }
                }

                # Trigger next event
                trigger_event = {
                    id = arrakis_struggle.011
                    days = { 7 14 }
                }

                # Catalyst
                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_paul_defeats_jamis
                        character = root
                    }
                }
            }
            50 = {
                compare_modifier = {
                    value = scope:duel_value
                    multiplier = -3.5
                }
                desc = arrakis_struggle.010.a.failure

                # Paul wounded but survives (plot armor for protagonist)
                add_character_modifier = {
                    modifier = wounded_in_duel
                    days = 60
                }

                stress_impact = {
                    base = major_stress_impact_gain
                }

                # Jamis shows mercy (rare)
                scope:jamis = {
                    add_opinion = {
                        target = root
                        modifier = pity_opinion
                        opinion = -10
                    }
                }

                # Rematch later
                trigger_event = {
                    id = arrakis_struggle.010
                    days = { 30 60 }
                }
            }
        }
    }

    # Use Bene Gesserit training
    option = {
        name = arrakis_struggle.010.b

        trigger = {
            has_trait = bene_gesserit_trained
        }

        # Automatic success with training
        scope:jamis = {
            death = {
                death_reason = death_duel
                killer = root
            }
        }

        add_character_flag = defeated_jamis
        add_prestige = 250

        # Extra respect for skill
        every_living_character = {
            limit = { has_culture = culture:fremen }
            add_opinion = {
                target = root
                modifier = awe_opinion
                opinion = 25
            }
        }

        trigger_event = {
            id = arrakis_struggle.011
            days = { 7 14 }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_defeats_jamis
                character = root
            }
        }
    }
}

# Accepted into Sietch Tabr
arrakis_struggle.011 = {
    type = character_event
    title = arrakis_struggle.011.t
    desc = arrakis_struggle.011.desc
    theme = friendly

    left_portrait = {
        character = scope:stilgar
        animation = personality_honorable
    }

    right_portrait = {
        character = root
        animation = personality_rational
    }

    trigger = {
        has_character_flag = paul_atreides
        has_character_flag = defeated_jamis
        NOT = { has_character_flag = accepted_by_fremen }
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = stilgar_naib }
            save_scope_as = stilgar
        }
    }

    # Accept fully - become Usul
    option = {
        name = arrakis_struggle.011.a

        add_character_flag = accepted_by_fremen
        add_trait = desert_adapted

        # Gain Fremen name
        set_nickname = nick_usul

        add_prestige = 300
        add_piety = 100

        # Stilgar becomes friend/ally
        if = {
            limit = { exists = scope:stilgar }
            set_relation_friend = scope:stilgar
        }

        trigger_event = {
            id = arrakis_struggle.012
            days = { 30 60 }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_accepted_by_fremen
                character = root
            }
        }
    }

    # Accept but maintain Atreides identity
    option = {
        name = arrakis_struggle.011.b

        add_character_flag = accepted_by_fremen
        add_trait = desert_adapted

        add_prestige = 200

        stress_impact = {
            base = minor_stress_impact_gain
        }

        trigger_event = {
            id = arrakis_struggle.012
            days = { 45 90 }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_accepted_by_fremen
                character = root
            }
        }
    }
}

# Learning the Desert Ways
arrakis_struggle.012 = {
    type = character_event
    title = arrakis_struggle.012.t
    desc = arrakis_struggle.012.desc
    theme = education

    left_portrait = {
        character = root
        animation = personality_rational
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        NOT = { has_character_flag = learned_desert_ways }
    }

    # Study water discipline
    option = {
        name = arrakis_struggle.012.a

        add_character_modifier = {
            modifier = water_discipline
            years = -1
        }

        add_stewardship_lifestyle_xp = 100

        trigger_event = {
            id = arrakis_struggle.013
            days = { 30 60 }
        }
    }

    # Focus on combat
    option = {
        name = arrakis_struggle.012.b

        add_prowess = 2
        add_martial_lifestyle_xp = 150

        trigger_event = {
            id = arrakis_struggle.013
            days = { 30 60 }
        }
    }

    # Learn the worm signs
    option = {
        name = arrakis_struggle.012.c

        add_character_modifier = {
            modifier = reads_the_sand
            years = 5
        }

        add_learning_lifestyle_xp = 100

        trigger_event = {
            id = arrakis_struggle.013
            days = { 30 60 }
        }
    }

    after = {
        add_character_flag = learned_desert_ways

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_learns_desert_ways
                character = root
            }
        }
    }
}

# First Stillsuit
arrakis_struggle.013 = {
    type = character_event
    title = arrakis_struggle.013.t
    desc = arrakis_struggle.013.desc
    theme = friendly

    left_portrait = {
        character = root
        animation = happiness
    }

    trigger = {
        has_character_flag = learned_desert_ways
        NOT = { has_character_modifier = owns_stillsuit }
    }

    option = {
        name = arrakis_struggle.013.a

        add_character_modifier = {
            modifier = owns_stillsuit
        }

        add_prestige = 50

        trigger_event = {
            id = arrakis_struggle.014
            days = { 60 120 }
        }
    }
}

# Whispers of Lisan al-Gaib
arrakis_struggle.014 = {
    type = character_event
    title = arrakis_struggle.014.t
    desc = arrakis_struggle.014.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = worry
    }

    right_portrait = {
        character = scope:jessica
        animation = personality_rational
    }

    trigger = {
        has_character_flag = paul_atreides
        has_character_flag = accepted_by_fremen
        NOT = { has_character_flag = heard_prophecy }
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = jessica_bene_gesserit }
            save_scope_as = jessica
        }
    }

    # Embrace the prophecy
    option = {
        name = arrakis_struggle.014.a

        add_character_flag = heard_prophecy
        add_character_flag = embraces_prophecy

        add_piety = 200
        add_prestige = 100

        every_living_character = {
            limit = { has_culture = culture:fremen }
            add_opinion = {
                target = root
                modifier = messiah_opinion
                opinion = 10
            }
        }

        trigger_event = {
            id = arrakis_struggle.015
            days = { 30 60 }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_lisan_al_gaib_whispers
                character = root
            }
        }
    }

    # Remain skeptical
    option = {
        name = arrakis_struggle.014.b

        add_character_flag = heard_prophecy

        add_prestige = 50

        stress_impact = {
            base = minor_stress_impact_gain
        }

        trigger_event = {
            id = arrakis_struggle.015
            days = { 30 60 }
        }
    }
}

# Harkonnen Patrol Encounter
arrakis_struggle.015 = {
    type = character_event
    title = arrakis_struggle.015.t
    desc = arrakis_struggle.015.desc
    theme = war

    left_portrait = {
        character = root
        animation = anger
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        is_alive = yes
    }

    # Ambush them
    option = {
        name = arrakis_struggle.015.a

        random_list = {
            70 = {
                modifier = {
                    has_trait = desert_adapted
                    add = 15
                }
                modifier = {
                    prowess >= 12
                    add = 10
                }

                send_interface_toast = {
                    title = arrakis_struggle.015.a.success
                    left_icon = root
                }

                add_prestige = 150
                add_gold = 50

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_harkonnen_patrol_destroyed
                        character = root
                    }
                }
            }
            30 = {
                send_interface_toast = {
                    title = arrakis_struggle.015.a.failure
                    left_icon = root
                }

                stress_impact = {
                    base = medium_stress_impact_gain
                }

                add_character_modifier = {
                    modifier = narrow_escape
                    days = 30
                }
            }
        }
    }

    # Hide and let them pass
    option = {
        name = arrakis_struggle.015.b

        add_prestige = -25

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_fremen_escape_patrol
                character = root
            }
        }
    }

    # Call a sandworm
    option = {
        name = arrakis_struggle.015.c

        trigger = {
            has_character_modifier = reads_the_sand
        }

        send_interface_toast = {
            title = arrakis_struggle.015.c.success
            left_icon = root
        }

        add_prestige = 200
        add_dread = 15

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_worm_attack_patrol
                character = root
            }
        }
    }
}

# Transition Check - Phase 1 Complete
arrakis_struggle.019 = {
    type = character_event
    title = arrakis_struggle.019.t
    desc = arrakis_struggle.019.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    trigger = {
        has_character_flag = paul_atreides
        has_character_flag = defeated_jamis
        has_character_flag = accepted_by_fremen
        has_character_flag = learned_desert_ways
    }

    option = {
        name = arrakis_struggle.019.a

        custom_tooltip = phase_2_unlocked_tt

        # Enable Phase 2 events
        add_character_flag = phase_2_ready
    }
}

####################################
# PHASE 2: RESISTANCE EVENTS (100-119)
####################################

# Harkonnen Reprisal
arrakis_struggle.100 = {
    type = character_event
    title = arrakis_struggle.100.t
    desc = arrakis_struggle.100.desc
    theme = war

    left_portrait = {
        character = root
        animation = grief
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        is_involved_in_struggle = struggle:arrakis_struggle
    }

    weight_multiplier = {
        base = 1
        modifier = {
            factor = 2
            any_struggle_catalyst = {
                has_catalyst = catalyst_fremen_raid_success
            }
        }
    }

    # Endure silently
    option = {
        name = arrakis_struggle.100.a

        stress_impact = {
            base = medium_stress_impact_gain
        }

        add_piety = 50
    }

    # Vow vengeance
    option = {
        name = arrakis_struggle.100.b

        add_character_modifier = {
            modifier = vengeance_sworn
            years = 2
        }

        add_dread = 10

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_harkonnen_atrocity
                character = root
            }
        }
    }
}

# Sietch Discovered
arrakis_struggle.101 = {
    type = character_event
    title = arrakis_struggle.101.t
    desc = arrakis_struggle.101.desc
    theme = war

    left_portrait = {
        character = root
        animation = fear
    }

    trigger = {
        has_character_flag = accepted_by_fremen
    }

    # Evacuate
    option = {
        name = arrakis_struggle.101.a

        add_gold = -100
        add_prestige = -50

        # Sietch survives
        custom_tooltip = sietch_evacuated_tt
    }

    # Ambush the attackers
    option = {
        name = arrakis_struggle.101.b

        random_list = {
            60 = {
                modifier = {
                    prowess >= 15
                    add = 20
                }
                modifier = {
                    has_character_modifier = fedaykin_trained
                    add = 15
                }

                trigger_event = arrakis_struggle.101_success

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_harkonnen_patrol_destroyed
                        character = root
                    }
                }
            }
            40 = {
                trigger_event = arrakis_struggle.101_failure

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_major_sietch_destroyed
                        character = root
                    }
                }
            }
        }
    }
}

# Ambush Success
arrakis_struggle.101_success = {
    type = character_event
    title = arrakis_struggle.101.b.success
    desc = arrakis_struggle.101_success.desc
    theme = war

    left_portrait = {
        character = root
        animation = war_cry
    }

    option = {
        name = arrakis_struggle.101_success.a

        add_prestige = 300
        add_gold = 100
        add_dread = 20
    }
}

# Sietch Lost
arrakis_struggle.101_failure = {
    type = character_event
    title = arrakis_struggle.101.b.failure
    desc = arrakis_struggle.101_failure.desc
    theme = death

    left_portrait = {
        character = root
        animation = grief
    }

    option = {
        name = arrakis_struggle.101_failure.a

        stress_impact = {
            base = major_stress_impact_gain
        }

        add_prestige = -100
    }
}

# Water Shortage
arrakis_struggle.102 = {
    type = character_event
    title = arrakis_struggle.102.t
    desc = arrakis_struggle.102.desc
    theme = plague

    left_portrait = {
        character = root
        animation = stress
    }

    trigger = {
        has_character_flag = accepted_by_fremen
    }

    # Strict rationing
    option = {
        name = arrakis_struggle.102.a

        add_character_modifier = {
            modifier = water_rationing_modifier
            days = 180
        }

        stress_impact = {
            base = minor_stress_impact_gain
        }
    }

    # Raid Harkonnens for water
    option = {
        name = arrakis_struggle.102.b

        random_list = {
            65 = {
                send_interface_toast = {
                    title = arrakis_struggle.102.b.success
                    left_icon = root
                }

                add_prestige = 100
                add_gold = 75

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_successful_caravan_raid
                        character = root
                    }
                }
            }
            35 = {
                send_interface_toast = {
                    title = arrakis_struggle.102.b.failure
                    left_icon = root
                }

                stress_impact = {
                    base = medium_stress_impact_gain
                }
            }
        }
    }
}

# First Sandworm Ride
arrakis_struggle.110 = {
    type = character_event
    title = arrakis_struggle.110.t
    desc = arrakis_struggle.110.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = ecstasy
    }

    trigger = {
        has_character_flag = paul_atreides
        has_character_flag = accepted_by_fremen
        NOT = { has_character_flag = has_ridden_worm }
    }

    # Ride the maker
    option = {
        name = arrakis_struggle.110.a

        random_list = {
            75 = {
                modifier = {
                    has_trait = brave
                    add = 15
                }
                modifier = {
                    prowess >= 12
                    add = 10
                }
                modifier = {
                    has_character_modifier = reads_the_sand
                    add = 10
                }

                # Success
                add_character_flag = has_ridden_worm
                add_trait = worm_rider

                add_prestige = 500
                add_piety = 200

                every_living_character = {
                    limit = { has_culture = culture:fremen }
                    add_opinion = {
                        target = root
                        modifier = worm_rider_opinion
                        opinion = 30
                    }
                }

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_paul_rides_sandworm
                        character = root
                    }
                }

                trigger_event = {
                    id = arrakis_struggle.111
                    days = { 30 60 }
                }
            }
            25 = {
                # Failure - nearly killed
                add_character_modifier = {
                    modifier = worm_riding_failure
                    days = 90
                }

                stress_impact = {
                    base = major_stress_impact_gain
                }

                # Try again later
                trigger_event = {
                    id = arrakis_struggle.110
                    days = { 60 120 }
                }
            }
        }
    }

    # Not ready yet
    option = {
        name = arrakis_struggle.110.b

        stress_impact = {
            base = minor_stress_impact_gain
        }

        trigger_event = {
            id = arrakis_struggle.110
            days = { 90 180 }
        }
    }
}

# Fedaykin Training
arrakis_struggle.111 = {
    type = character_event
    title = arrakis_struggle.111.t
    desc = arrakis_struggle.111.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        NOT = { has_character_modifier = fedaykin_trained }
    }

    # Complete training
    option = {
        name = arrakis_struggle.111.a

        add_character_modifier = {
            modifier = fedaykin_trained
        }

        add_prowess = 4
        add_martial = 2

        add_prestige = 200

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_fedaykin_trained
                character = root
            }
        }
    }
}

# Spice Caravan Raid
arrakis_struggle.112 = {
    type = character_event
    title = arrakis_struggle.112.t
    desc = arrakis_struggle.112.desc
    theme = war

    left_portrait = {
        character = root
        animation = war_cry
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        has_character_modifier = fedaykin_trained
    }

    # Lead the raid personally
    option = {
        name = arrakis_struggle.112.a

        random_list = {
            70 = {
                modifier = {
                    martial >= 15
                    add = 15
                }
                modifier = {
                    has_trait = worm_rider
                    add = 10
                }

                # Success
                add_gold = 300
                add_prestige = 250

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_successful_caravan_raid
                        character = root
                    }
                    activate_struggle_catalyst = {
                        catalyst = catalyst_paul_leads_raid
                        character = root
                    }
                }
            }
            30 = {
                # Partial success
                add_gold = 100
                add_prestige = 75

                stress_impact = {
                    base = minor_stress_impact_gain
                }
            }
        }
    }

    # Delegate to experienced raiders
    option = {
        name = arrakis_struggle.112.b

        add_gold = 150
        add_prestige = 50

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_successful_caravan_raid
                character = root
            }
        }
    }
}

# Growing Legend - Muad'Dib Spreads
arrakis_struggle.113 = {
    type = character_event
    title = arrakis_struggle.113.t
    desc = arrakis_struggle.113.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = personality_zealous
    }

    trigger = {
        has_character_flag = paul_atreides
        has_trait = worm_rider
        has_character_modifier = fedaykin_trained
    }

    immediate = {
        set_nickname = nick_muaddib
    }

    # Embrace your legend
    option = {
        name = arrakis_struggle.113.a

        add_prestige = 500
        add_piety = 300

        every_living_character = {
            limit = { has_culture = culture:fremen }
            add_opinion = {
                target = root
                modifier = messiah_opinion
                opinion = 25
            }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_mahdi_prophecy_spreads
                character = root
            }
        }
    }

    # Remain humble
    option = {
        name = arrakis_struggle.113.b

        add_prestige = 200
        add_piety = 100

        add_trait = humble

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_mahdi_prophecy_spreads
                character = root
            }
        }
    }
}

####################################
# PHASE 3: OPEN WAR EVENTS (200-219)
####################################

# Successful Ambush
arrakis_struggle.200 = {
    type = character_event
    title = arrakis_struggle.200.t
    desc = arrakis_struggle.200.desc
    theme = war

    left_portrait = {
        character = root
        animation = war_cry
    }

    trigger = {
        has_character_flag = accepted_by_fremen
        struggle:arrakis_struggle = {
            is_struggle_phase = arrakis_struggle_open_war
        }
    }

    option = {
        name = arrakis_struggle.200.a

        add_gold = 200
        add_prestige = 300
        add_dread = 15

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_harkonnen_patrol_destroyed
                character = root
            }
        }
    }
}

# Spice Blow!
arrakis_struggle.201 = {
    type = character_event
    title = arrakis_struggle.201.t
    desc = arrakis_struggle.201.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = shock
    }

    trigger = {
        has_character_flag = accepted_by_fremen
    }

    # Harvest carefully
    option = {
        name = arrakis_struggle.201.a

        add_gold = 300

        custom_tooltip = spice_harvested_safely_tt
    }

    # Harvest everything quickly
    option = {
        name = arrakis_struggle.201.b

        random_list = {
            50 = {
                add_gold = 600
                add_prestige = 100
            }
            50 = {
                trigger_event = arrakis_struggle.202
            }
        }
    }
}

# Shai-Hulud Comes!
arrakis_struggle.202 = {
    type = character_event
    title = arrakis_struggle.202.t
    desc = arrakis_struggle.202.desc
    theme = death

    left_portrait = {
        character = root
        animation = fear
    }

    option = {
        name = arrakis_struggle.202.a

        add_gold = -100
        stress_impact = {
            base = medium_stress_impact_gain
        }

        # Some Fremen lost
        custom_tooltip = fremen_lost_to_worm_tt
    }
}

# The Mahdi Revealed
arrakis_struggle.210 = {
    type = character_event
    title = arrakis_struggle.210.t
    desc = arrakis_struggle.210.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = ecstasy
    }

    right_portrait = {
        character = scope:stilgar
        animation = personality_zealous
    }

    trigger = {
        has_character_flag = paul_atreides
        has_trait = worm_rider
        OR = {
            has_trait = prescient
            has_character_flag = embraces_prophecy
        }
        NOT = { has_character_flag = declared_mahdi }
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = stilgar_naib }
            save_scope_as = stilgar
        }
    }

    # Accept the mantle
    option = {
        name = arrakis_struggle.210.a

        add_character_flag = declared_mahdi
        add_trait = mahdi

        add_prestige = 1000
        add_piety = 500

        # All Fremen follow
        every_living_character = {
            limit = { has_culture = culture:fremen }
            add_opinion = {
                target = root
                modifier = messiah_devotion_opinion
                opinion = 50
            }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_revealed_as_mahdi
                character = root
            }
            activate_struggle_catalyst = {
                catalyst = catalyst_all_sietches_united
                character = root
            }
        }
    }
}

# Sardaukar Clash
arrakis_struggle.211 = {
    type = character_event
    title = arrakis_struggle.211.t
    desc = arrakis_struggle.211.desc
    theme = war

    left_portrait = {
        character = root
        animation = anger
    }

    trigger = {
        struggle:arrakis_struggle = {
            is_struggle_phase = arrakis_struggle_open_war
        }
        has_character_flag = accepted_by_fremen
    }

    # Meet them in battle
    option = {
        name = arrakis_struggle.211.a

        random_list = {
            60 = {
                modifier = {
                    has_trait = mahdi
                    add = 20
                }
                modifier = {
                    has_character_modifier = fedaykin_trained
                    add = 15
                }

                # Victory against elite troops
                add_prestige = 500
                add_dread = 30

                struggle:arrakis_struggle = {
                    activate_struggle_catalyst = {
                        catalyst = catalyst_major_harkonnen_defeat
                        character = root
                    }
                }
            }
            40 = {
                # Costly victory
                add_prestige = 200

                stress_impact = {
                    base = medium_stress_impact_gain
                }

                add_character_modifier = {
                    modifier = battle_wounds
                    days = 90
                }
            }
        }
    }

    # Guerrilla tactics
    option = {
        name = arrakis_struggle.211.b

        add_prestige = 200
        add_gold = 150

        custom_tooltip = sardaukar_harassed_tt
    }
}

# Sietches United
arrakis_struggle.212 = {
    type = character_event
    title = arrakis_struggle.212.t
    desc = arrakis_struggle.212.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    trigger = {
        has_character_flag = declared_mahdi
    }

    option = {
        name = arrakis_struggle.212.a

        add_prestige = 300

        # Massive military boost
        add_character_modifier = {
            modifier = united_fremen_army
            years = 5
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_all_sietches_united
                character = root
            }
        }
    }
}

# Worm Army Summoned
arrakis_struggle.213 = {
    type = character_event
    title = arrakis_struggle.213.t
    desc = arrakis_struggle.213.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = ecstasy
    }

    trigger = {
        has_trait = worm_rider
        has_character_flag = declared_mahdi
        struggle:arrakis_struggle = {
            is_struggle_phase = arrakis_struggle_open_war
        }
    }

    option = {
        name = arrakis_struggle.213.a

        add_character_modifier = {
            modifier = commands_the_worms
            years = 2
        }

        add_prestige = 500
        add_dread = 50

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_controls_worms
                character = root
            }
            activate_struggle_catalyst = {
                catalyst = catalyst_mass_worm_attack
                character = root
            }
        }
    }
}

# Harkonnen Fortress Falls
arrakis_struggle.214 = {
    type = character_event
    title = arrakis_struggle.214.t
    desc = arrakis_struggle.214.desc
    theme = war

    left_portrait = {
        character = root
        animation = war_cry
    }

    trigger = {
        has_character_flag = declared_mahdi
        has_character_modifier = commands_the_worms
    }

    # Storm the fortress
    option = {
        name = arrakis_struggle.214.a

        add_prestige = 750
        add_gold = 500
        add_dread = 40

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_harkonnen_fortress_falls
                character = root
            }
            activate_struggle_catalyst = {
                catalyst = catalyst_arrakeen_threatened
                character = root
            }
        }

        # Emperor takes notice
        trigger_event = {
            id = arrakis_struggle.300
            days = { 30 60 }
        }
    }
}

####################################
# PHASE 4: RESOLUTION EVENTS (300-399)
####################################

# The Emperor Arrives
arrakis_struggle.300 = {
    type = character_event
    title = arrakis_struggle.300.t
    desc = arrakis_struggle.300.desc
    theme = war

    left_portrait = {
        character = scope:emperor
        animation = personality_bold
    }

    right_portrait = {
        character = root
        animation = personality_rational
    }

    trigger = {
        struggle:arrakis_struggle = {
            OR = {
                is_struggle_phase = arrakis_struggle_open_war
                is_struggle_phase = arrakis_struggle_resolution
            }
        }
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = emperor_shaddam }
            save_scope_as = emperor
        }
    }

    # Let him come
    option = {
        name = arrakis_struggle.300.a

        add_prestige = 200
        add_dread = 30

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_emperor_intervenes
                character = root
            }
            activate_struggle_catalyst = {
                catalyst = catalyst_sardaukar_deployed
                character = root
            }
        }

        # Trigger Kwisatz Haderach path if eligible
        if = {
            limit = {
                has_character_flag = paul_atreides
                has_trait = prescient
                OR = {
                    dynasty = dynasty:atreides
                    dynasty = dynasty:harkonnen
                }
            }
            trigger_event = {
                id = arrakis_struggle.301
                days = { 14 30 }
            }
        }
    }
}

# Water of Life Trial
arrakis_struggle.301 = {
    type = character_event
    title = arrakis_struggle.301.t
    desc = arrakis_struggle.301.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = pain
    }

    trigger = {
        OR = {
            dynasty = dynasty:atreides
            dynasty = dynasty:harkonnen
        }
        has_trait = prescient
        NOT = { has_trait = kwisatz_haderach }
        NOT = { has_character_flag = failed_water_of_life }
    }

    # Drink the Water of Life
    option = {
        name = arrakis_struggle.301.a

        trigger_event = arrakis_struggle.302
    }

    # Not yet ready
    option = {
        name = arrakis_struggle.301.b

        stress_impact = {
            base = minor_stress_impact_gain
        }

        # Try again later
        trigger_event = {
            id = arrakis_struggle.301
            days = { 30 60 }
        }
    }
}

# The Spice Agony
arrakis_struggle.302 = {
    type = character_event
    title = arrakis_struggle.302.t
    desc = arrakis_struggle.302.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = pain
    }

    trigger = {
        OR = {
            dynasty = dynasty:atreides
            dynasty = dynasty:harkonnen
        }
    }

    immediate = {
        # Calculate survival chance
        # Base 40%, modified by traits
        set_variable = {
            name = agony_survival_chance
            value = 40
        }

        if = {
            limit = { has_trait = bene_gesserit_trained }
            change_variable = {
                name = agony_survival_chance
                add = 20
            }
        }
        if = {
            limit = { has_trait = prescient }
            change_variable = {
                name = agony_survival_chance
                add = 15
            }
        }
        if = {
            limit = { has_trait = spice_addict }
            change_variable = {
                name = agony_survival_chance
                add = 10
            }
        }
        if = {
            limit = { learning >= 15 }
            change_variable = {
                name = agony_survival_chance
                add = 10
            }
        }
    }

    # Must survive
    option = {
        name = arrakis_struggle.302.a

        random_list = {
            1 = {
                # Weight by survival chance
                modifier = {
                    add = var:agony_survival_chance
                }

                # SUCCESS - Become Kwisatz Haderach
                trigger_event = arrakis_struggle.303
            }
            1 = {
                modifier = {
                    add = 100
                    subtract = var:agony_survival_chance
                }

                # FAILURE - Death
                trigger_event = arrakis_struggle.304
            }
        }
    }
}

# The Kwisatz Haderach Awakens
arrakis_struggle.303 = {
    type = character_event
    title = arrakis_struggle.303.t
    desc = arrakis_struggle.303.desc
    theme = mystic

    left_portrait = {
        character = root
        animation = ecstasy
    }

    right_portrait = {
        character = root
        animation = personality_rational
        camera = camera_event_right
    }

    option = {
        name = arrakis_struggle.303.a

        add_trait = kwisatz_haderach

        # Remove lesser versions
        if = {
            limit = { has_trait = prescient }
            remove_trait = prescient
        }

        add_prestige = 2000
        add_piety = 1000

        # Massive stat boosts
        add_prowess = 5
        add_martial = 5
        add_learning = 5
        add_intrigue = 5
        add_diplomacy = 5
        add_stewardship = 5

        # Everyone fears/respects
        add_dread = 100

        every_living_character = {
            add_opinion = {
                target = root
                modifier = kwisatz_haderach_opinion
                opinion = 50
            }
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_kwisatz_haderach_awakens
                character = root
            }
        }

        # Trigger final battle
        trigger_event = {
            id = arrakis_struggle.400
            days = { 14 30 }
        }
    }
}

# Death by Spice Agony
arrakis_struggle.304 = {
    type = character_event
    title = arrakis_struggle.304.t
    desc = arrakis_struggle.304.desc
    theme = death

    left_portrait = {
        character = root
        animation = pain
    }

    option = {
        name = arrakis_struggle.304.a

        death = {
            death_reason = death_spice_agony
        }

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_paul_killed
                character = root
            }
        }
    }
}

# The Final Battle
arrakis_struggle.400 = {
    type = character_event
    title = arrakis_struggle.400.t
    desc = arrakis_struggle.400.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    right_portrait = {
        character = scope:emperor
        animation = fear
    }

    trigger = {
        struggle:arrakis_struggle = {
            is_struggle_phase = arrakis_struggle_resolution
        }
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = emperor_shaddam }
            save_scope_as = emperor
        }
    }

    # Lead the assault
    option = {
        name = arrakis_struggle.400.a

        struggle:arrakis_struggle = {
            activate_struggle_catalyst = {
                catalyst = catalyst_final_battle_begins
                character = root
            }
        }

        # Determine outcome based on traits/modifiers
        if = {
            limit = {
                has_trait = kwisatz_haderach
                has_character_modifier = commands_the_worms
            }
            # Guaranteed victory
            trigger_event = arrakis_struggle.500
        }
        else_if = {
            limit = {
                has_trait = mahdi
                has_character_modifier = united_fremen_army
            }
            # High chance of victory
            random_list = {
                80 = {
                    trigger_event = arrakis_struggle.500
                }
                20 = {
                    trigger_event = arrakis_struggle.560
                }
            }
        }
        else = {
            # Lower chances
            random_list = {
                50 = {
                    trigger_event = arrakis_struggle.500
                }
                30 = {
                    trigger_event = arrakis_struggle.560
                }
                20 = {
                    trigger_event = arrakis_struggle.550
                }
            }
        }
    }
}

####################################
# ENDING EVENTS (500-599)
####################################

# Fremen Victory
arrakis_struggle.500 = {
    type = character_event
    title = arrakis_struggle.500.t
    desc = arrakis_struggle.500.desc
    theme = war

    left_portrait = {
        character = root
        animation = personality_bold
    }

    right_portrait = {
        character = scope:emperor
        animation = shame
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = emperor_shaddam }
            save_scope_as = emperor
        }
    }

    # Claim the throne
    option = {
        name = arrakis_struggle.500.a

        add_prestige = 5000
        add_piety = 2000

        # Become Emperor
        if = {
            limit = { exists = title:e_known_universe }
            create_title_and_vassal_change = {
                type = usurped
                save_scope_as = title_change
            }
            title:e_known_universe = {
                change_title_holder = {
                    holder = root
                    change = scope:title_change
                }
            }
            resolve_title_and_vassal_change = scope:title_change
        }

        # End the struggle
        struggle:arrakis_struggle = {
            end_struggle = {
                outcome = arrakis_struggle_fremen_victory
            }
        }

        # Warning of jihad to come
        custom_tooltip = jihad_warning_tt
    }
}

# Harkonnen Dominance
arrakis_struggle.550 = {
    type = character_event
    title = arrakis_struggle.550.t
    desc = arrakis_struggle.550.desc
    theme = war

    left_portrait = {
        character = scope:baron
        animation = schadenfreude
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = baron_harkonnen }
            save_scope_as = baron
        }
    }

    # The prophecy failed
    option = {
        name = arrakis_struggle.550.a

        # If Paul still lives, he must flee or die
        if = {
            limit = {
                has_character_flag = paul_atreides
                is_alive = yes
            }
            add_trait = exiled
            add_prestige = -1000
        }

        struggle:arrakis_struggle = {
            end_struggle = {
                outcome = arrakis_struggle_harkonnen_dominance
            }
        }
    }
}

# Imperial Intervention
arrakis_struggle.560 = {
    type = character_event
    title = arrakis_struggle.560.t
    desc = arrakis_struggle.560.desc
    theme = diplomacy

    left_portrait = {
        character = scope:emperor
        animation = personality_rational
    }

    right_portrait = {
        character = root
        animation = personality_rational
    }

    immediate = {
        random_living_character = {
            limit = { has_character_flag = emperor_shaddam }
            save_scope_as = emperor
        }
    }

    # Accept the Emperor's terms
    option = {
        name = arrakis_struggle.560.a

        add_prestige = 1000
        add_gold = 500

        # Fremen get autonomy but not full victory
        add_character_modifier = {
            modifier = fremen_autonomy
            years = -1
        }

        struggle:arrakis_struggle = {
            end_struggle = {
                outcome = arrakis_struggle_imperial_intervention
            }
        }
    }

    # Reject and fight on
    option = {
        name = arrakis_struggle.560.b

        add_prestige = 200
        add_dread = 20

        # War continues - doesn't end struggle
        trigger_event = {
            id = arrakis_struggle.400
            days = { 60 120 }
        }
    }
}
